<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Calibration - Eye Movement Data Collection</title>
    <!-- WebGazer for Eye Tracking -->
    <script defer src="https://cdn.jsdelivr.net/npm/webgazer"></script>
    <style>
        /* Basic Reset */
        body, html {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            overflow: hidden;
        }

        /* Container */
        .container {
            width: 100%;
            height: 100%;
            position: relative;
        }

        /* Calibration Points */
        .calibrationPoint {
            width: 20px;
            height: 20px;
            background-color: #007BFF;
            border-radius: 50%;
            position: absolute;
            visibility: hidden;
            transition: visibility 0.3s ease-in-out, background-color 0.3s;
            transform: translate(-50%, -50%);
            z-index: 2;
        }

        /* Calibration Message */
        #calibrationMessage {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            color: #007BFF;
            font-size: 1.5em;
            z-index: 1;
            text-align: center;
            width: 80%;
        }

        /* Video Element (Hidden) */
        #webgazerVideoFeed {
            display: none;
        }

        /* Fullscreen Mask */
        .mask {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(240, 242, 245, 0.9);
            z-index: 0;
        }

        /* Footer Styling */
        footer {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            color: #777;
            font-size: 0.9em;
            z-index: 1;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            #calibrationMessage {
                font-size: 1.2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="mask"></div>
        <div id="calibrationMessage">Calibration in progress... Please focus on each dot until it disappears.</div>

        <!-- Calibration Points -->
        <div id="calibrationDiv" class="calibration">
            <div class="calibrationPoint" id="point1" style="top: 10%; left: 10%;"></div>
            <div class="calibrationPoint" id="point2" style="top: 10%; left: 50%;"></div>
            <div class="calibrationPoint" id="point3" style="top: 10%; left: 90%;"></div>
            <div class="calibrationPoint" id="point4" style="top: 50%; left: 10%;"></div>
            <div class="calibrationPoint" id="point5" style="top: 50%; left: 50%;"></div>
            <div class="calibrationPoint" id="point6" style="top: 50%; left: 90%;"></div>
            <div class="calibrationPoint" id="point7" style="top: 90%; left: 10%;"></div>
            <div class="calibrationPoint" id="point8" style="top: 90%; left: 50%;"></div>
            <div class="calibrationPoint" id="point9" style="top: 90%; left: 90%;"></div>
        </div>

        <footer>
            <p>&copy; 2024 Eye Movement Research</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const calibrationPoints = document.querySelectorAll('.calibrationPoint');
            const calibrationMessage = document.getElementById('calibrationMessage');
            const totalPoints = calibrationPoints.length;
            let currentPoint = 0;
            let calibrationSamples = 0;
            const samplesPerPoint = 30; // Number of samples to collect per point

            // Initialize WebGazer
            initializeWebGazer();

            function initializeWebGazer() {
                webgazer.setRegression('ridge') // You can choose the regression model
                    .setTracker('clmtrackr') // You can choose the face tracker
                    .begin()
                    .showVideo(false)
                    .showFaceOverlay(false)
                    .showFaceFeedbackBox(false);

                // Wait for the webgazer to be ready
                webgazer.setGazeListener(function(data, elapsedTime) {
                    // Gaze data is being received
                });

                // Start calibration after WebGazer is ready
                webgazer.getTracker().on('prediction', function() {
                    // Start calibration after initial prediction to ensure WebGazer is ready
                    webgazer.getTracker().off('prediction'); // Remove this handler after it's called
                    startCalibration();
                });
            }

            function startCalibration() {
                calibrationMessage.textContent = 'Calibration in progress... Please focus on each dot until it disappears.';
                showNextCalibrationPoint();
            }

            function showNextCalibrationPoint() {
                if (currentPoint >= totalPoints) {
                    finishCalibration();
                    return;
                }

                const point = calibrationPoints[currentPoint];
                point.style.visibility = 'visible';
                calibrationSamples = 0;

                // Collect gaze data samples for this point
                const sampleInterval = setInterval(() => {
                    calibrationSamples++;
                    const x = point.offsetLeft + point.offsetWidth / 2;
                    const y = point.offsetTop + point.offsetHeight / 2;
                    webgazer.recordScreenPosition(x, y);

                    if (calibrationSamples >= samplesPerPoint) {
                        clearInterval(sampleInterval);
                        point.style.visibility = 'hidden';
                        currentPoint++;
                        setTimeout(showNextCalibrationPoint, 500); // Short pause before next point
                    }
                }, 50); // Collect samples every 50ms
            }

            function finishCalibration() {
                calibrationMessage.textContent = 'Calibration complete. Verifying...';

                // Optional: Add verification logic here to ensure calibration quality

                // Simulate verification delay
                setTimeout(() => {
                    calibrationMessage.textContent = 'Calibration successful. Redirecting...';
                    redirectToNextPage();
                }, 2000);
            }

            function redirectToNextPage() {
                setTimeout(() => {
                    window.location.href = 'gaze4.html'; // Redirect to the visual task and assessment page
                }, 1000); // Redirect after 1 second
            }

            // Ensure data is saved when the page is unloaded
            window.addEventListener('beforeunload', function (e) {
                webgazer.end();
            });
        });
    </script>
</body>
</html>
